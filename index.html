<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Arena - Fixed Controls</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Reset total para evitar scroll e comportamentos estranhos no mobile */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        /* --- LOBBY --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #111;
            z-index: 1000;
        }

        .panel {
            background: #222; padding: 20px; border: 2px solid #444;
            text-align: center; width: 300px;
        }

        input {
            width: 100%; padding: 10px; margin-bottom: 10px;
            background: #000; border: 1px solid #4ecca3; color: #4ecca3;
            text-align: center; font-family: inherit;
        }

        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: 1px solid #fff; background: #000; color: #fff;
            font-family: inherit; cursor: pointer;
        }
        button:active { background: #4ecca3; color: #000; }

        /* --- GAME LAYOUT --- */
        #game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: none;
        }

        canvas { background: #050505; display: block; width: 100%; height: 100%; }

        /* --- CHAT (Compacto estilo RPG) --- */
        #chat-wrapper {
            position: absolute; top: 10px; left: 10px;
            width: 180px; background: rgba(0,0,0,0.8);
            border: 1px solid #444; padding: 5px; z-index: 100;
        }
        #chat-history { height: 60px; overflow-y: auto; font-size: 10px; margin-bottom: 4px; border-bottom: 1px solid #333; }
        #chat-input { width: 100%; background: #000; border: none; color: #fff; font-size: 10px; }

        /* --- CONTROLES VIRTUAIS (Inspirados no seu RPG-RoGueLiKe) --- */
        .dpad {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 2000; /* Garante que fique acima do canvas */
            display: grid;
            grid-template-columns: repeat(3, 55px);
            grid-template-rows: repeat(3, 55px);
            gap: 5px;
        }

        .ctrl-btn {
            width: 55px;
            height: 55px;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #fff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            user-select: none;
            cursor: pointer;
        }

        .ctrl-btn:active { background: #4ecca3; color: #000; }
        .btn-up { grid-column: 2; grid-row: 1; }
        .btn-left { grid-column: 1; grid-row: 2; }
        .btn-down { grid-column: 2; grid-row: 3; }
        .btn-right { grid-column: 3; grid-row: 2; }

    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="panel">
            <h2 style="color:#4ecca3; margin-bottom:10px;">P2P ARENA</h2>
            <input type="text" id="room-code" placeholder="NOME DA SALA">
            <button onclick="Game.init(true)">CRIAR SALA</button>
            <button onclick="Game.init(false)">ENTRAR NA SALA</button>
            <p id="status-msg" style="font-size:10px; margin-top:10px;">AGUARDANDO...</p>
        </div>
    </div>

    <div id="game-wrapper">
        <div id="chat-wrapper">
            <div id="chat-history"></div>
            <input type="text" id="chat-input" placeholder="DIGITE E ENTER..." onkeydown="if(event.key==='Enter') Chat.send()">
        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="dpad">
            <div class="ctrl-btn btn-up" ontouchstart="Input.set('up', true)" ontouchend="Input.set('up', false)" onmousedown="Input.set('up', true)" onmouseup="Input.set('up', false)">▲</div>
            <div class="ctrl-btn btn-left" ontouchstart="Input.set('left', true)" ontouchend="Input.set('left', false)" onmousedown="Input.set('left', true)" onmouseup="Input.set('left', false)">◄</div>
            <div class="ctrl-btn btn-down" ontouchstart="Input.set('down', true)" ontouchend="Input.set('down', false)" onmousedown="Input.set('down', true)" onmouseup="Input.set('down', false)">▼</div>
            <div class="ctrl-btn btn-right" ontouchstart="Input.set('right', true)" ontouchend="Input.set('right', false)" onmousedown="Input.set('right', true)" onmouseup="Input.set('right', false)">►</div>
        </div>
    </div>

    <script>
        const Game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: document.getElementById('gameCanvas').getContext('2d'),
            peer: null, conn: null,
            me: { x: 50, y: 50, color: '#4ecca3' },
            enemy: { x: -100, y: -100, color: '#ff6b6b', active: false },
            isHost: false, lastSent: 0,

            init(isHost) {
                const code = document.getElementById('room-code').value.trim();
                if (!code) return alert("DIGITE O NOME DA SALA!");
                this.isHost = isHost;
                document.getElementById('status-msg').innerText = "CONECTANDO...";
                
                this.peer = new Peer(isHost ? code : null);
                this.peer.on('open', (id) => {
                    if (isHost) document.getElementById('status-msg').innerText = "SALA: " + id + " | AGUARDANDO...";
                    else this.connect(code);
                });
                this.peer.on('connection', (c) => this.setupConn(c));
                this.peer.on('error', (err) => alert("ERRO: " + err.type));
            },

            connect(targetId) {
                this.setupConn(this.peer.connect(targetId));
            },

            setupConn(c) {
                this.conn = c;
                this.conn.on('open', () => {
                    document.getElementById('ui-layer').style.display = 'none';
                    document.getElementById('game-wrapper').style.display = 'block';
                    this.resize();
                    if(this.isHost) {
                        this.me.x = 50; this.me.y = 50;
                        this.conn.send({type:'start', x: 200, y: 200});
                    }
                    requestAnimationFrame(() => this.loop());
                });
                this.conn.on('data', (data) => {
                    if(data.type === 'start') { this.me.x = data.x; this.me.y = data.y; }
                    if(data.type === 'move') { this.enemy.x = data.x; this.enemy.y = data.y; this.enemy.active = true; }
                    if(data.type === 'chat') Chat.add(data.msg, 'enemy');
                });
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            update() {
                let moved = false;
                const speed = 5;
                if(Input.keys.up && this.me.y > 0) { this.me.y -= speed; moved = true; }
                if(Input.keys.down && this.me.y < this.canvas.height - 40) { this.me.y += speed; moved = true; }
                if(Input.keys.left && this.me.x > 0) { this.me.x -= speed; moved = true; }
                if(Input.keys.right && this.me.x < this.canvas.width - 40) { this.me.x += speed; moved = true; }

                if(moved && Date.now() - this.lastSent > 30) {
                    if(this.conn) this.conn.send({type:'move', x: this.me.x, y: this.me.y});
                    this.lastSent = Date.now();
                }
            },

            draw() {
                this.ctx.fillStyle = "#050505";
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Desenhar Inimigo
                if(this.enemy.active) {
                    this.ctx.fillStyle = this.enemy.color;
                    this.ctx.fillRect(this.enemy.x, this.enemy.y, 40, 40);
                    this.ctx.strokeStyle = "#fff";
                    this.ctx.strokeRect(this.enemy.x, this.enemy.y, 40, 40);
                }
                
                // Desenhar Eu
                this.ctx.fillStyle = this.me.color;
                this.ctx.fillRect(this.me.x, this.me.y, 40, 40);
                this.ctx.strokeStyle = "#fff";
                this.ctx.strokeRect(this.me.x, this.me.y, 40, 40);
            },

            loop() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        };

        const Input = {
            keys: { up: false, down: false, left: false, right: false },
            set(dir, state) { 
                this.keys[dir] = state; 
                // Evita que o toque no botão dispare scroll no mobile
                if(window.event) window.event.preventDefault();
            }
        };

        const Chat = {
            send() {
                const el = document.getElementById('chat-input');
                const msg = el.value.trim();
                if(!msg) return;
                this.add(msg, 'me');
                if(Game.conn) Game.conn.send({type:'chat', msg: msg});
                el.value = '';
            },
            add(msg, sender) {
                const h = document.getElementById('chat-history');
                h.innerHTML += `<div><b style="color:${sender==='me'?'#4ecca3':'#ff6b6b'}">${sender}:</b> ${msg}</div>`;
                h.scrollTop = h.scrollHeight;
            }
        };

        window.addEventListener('resize', () => Game.resize());
        
        // Teclado também funciona para teste no PC
        window.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowUp' || e.key === 'w') Input.keys.up = true;
            if(e.key === 'ArrowDown' || e.key === 's') Input.keys.down = true;
            if(e.key === 'ArrowLeft' || e.key === 'a') Input.keys.left = true;
            if(e.key === 'ArrowRight' || e.key === 'd') Input.keys.right = true;
        });
        window.addEventListener('keyup', (e) => {
            if(e.key === 'ArrowUp' || e.key === 'w') Input.keys.up = false;
            if(e.key === 'ArrowDown' || e.key === 's') Input.keys.down = false;
            if(e.key === 'ArrowLeft' || e.key === 'a') Input.keys.left = false;
            if(e.key === 'ArrowRight' || e.key === 'd') Input.keys.right = false;
        });
    </script>
</body>
</html>
