<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Arena - Mobile Test</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: #eee;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        /* --- LOBBY --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(18, 18, 18, 0.95);
            z-index: 100;
        }

        .panel {
            background: #1e1e2f; padding: 30px; border-radius: 12px;
            text-align: center; width: 320px; border: 1px solid #333;
        }

        input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: #2a2a40; border: 1px solid #444; color: #fff;
            border-radius: 6px; text-align: center;
        }

        .btn-group { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; color: #fff;
        }
        .btn-host { background: #4ecca3; color: #000; }
        .btn-join { background: #393e46; border: 1px solid #eee; }

        /* --- GAME --- */
        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: none; /* Aparece após iniciar */
        }

        canvas { background: #1a1a2e; width: 100%; height: 100%; display: block; }

        /* --- CHAT --- */
        #chat-wrapper {
            position: absolute; top: 10px; right: 10px;
            width: 200px; height: 120px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px; padding: 5px;
            display: flex; flex-direction: column; z-index: 50;
        }
        #chat-history { flex: 1; overflow-y: auto; font-size: 10px; margin-bottom: 5px; }
        #chat-input { background: #222; border: 1px solid #444; color: #fff; padding: 4px; font-size: 11px; width: 100%; }

        /* --- CONTROLES MOBILE (Sempre visíveis para teste) --- */
        #mobile-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: grid;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            gap: 10px;
            z-index: 60;
        }

        .dpad-btn {
            width: 65px;
            height: 65px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            user-select: none;
        }

        .dpad-btn:active { background: rgba(78, 204, 163, 0.6); border-color: #4ecca3; }
        .up { grid-area: up; }
        .down { grid-area: down; }
        .left { grid-area: left; }
        .right { grid-area: right; }

    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="panel">
            <h1>⚔️ P2P Arena</h1>
            <input type="text" id="room-code" placeholder="Nome da Sala">
            <div class="btn-group">
                <button class="btn-host" onclick="Game.init(true)">Criar</button>
                <button class="btn-join" onclick="Game.init(false)">Entrar</button>
            </div>
            <p id="status-msg" style="margin-top:10px; font-size:12px; color: #aaa;">Aguardando...</p>
        </div>
    </div>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div id="chat-wrapper">
            <div id="chat-history"></div>
            <input type="text" id="chat-input" placeholder="Chat..." onkeydown="if(event.key==='Enter') Chat.send()">
        </div>

        <div id="mobile-controls">
            <div class="dpad-btn up" ontouchstart="Input.set('up', true)" ontouchend="Input.set('up', false)" onmousedown="Input.set('up', true)" onmouseup="Input.set('up', false)">↑</div>
            <div class="dpad-btn left" ontouchstart="Input.set('left', true)" ontouchend="Input.set('left', false)" onmousedown="Input.set('left', true)" onmouseup="Input.set('left', false)">←</div>
            <div class="dpad-btn right" ontouchstart="Input.set('right', true)" ontouchend="Input.set('right', false)" onmousedown="Input.set('right', true)" onmouseup="Input.set('right', false)">→</div>
            <div class="dpad-btn down" ontouchstart="Input.set('down', true)" ontouchend="Input.set('down', false)" onmousedown="Input.set('down', true)" onmouseup="Input.set('down', false)">↓</div>
        </div>
    </div>

    <script>
        const Game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: document.getElementById('gameCanvas').getContext('2d'),
            peer: null, conn: null,
            me: { x: 100, y: 100, color: '#4ecca3' },
            enemy: { x: -100, y: -100, color: '#ff6b6b', active: false },
            isHost: false, lastSent: 0,

            init(isHost) {
                const code = document.getElementById('room-code').value.trim();
                if (!code) return alert("Insira um nome!");
                this.isHost = isHost;
                document.getElementById('status-msg').innerText = "Conectando...";
                
                this.peer = new Peer(isHost ? code : null);
                this.peer.on('open', (id) => {
                    if (isHost) document.getElementById('status-msg').innerText = "Aguardando oponente...";
                    else this.connect(code);
                });
                this.peer.on('connection', (c) => this.setupConn(c));
            },

            connect(targetId) {
                this.setupConn(this.peer.connect(targetId));
            },

            setupConn(c) {
                this.conn = c;
                this.conn.on('open', () => {
                    document.getElementById('ui-layer').style.display = 'none';
                    document.getElementById('game-wrapper').style.display = 'block';
                    this.resize();
                    if(this.isHost) {
                        this.me.x = 50; this.me.y = 200;
                        this.conn.send({type:'start', x: 250, y: 200});
                    }
                    requestAnimationFrame(() => this.loop());
                });
                this.conn.on('data', (data) => {
                    if(data.type === 'start') { this.me.x = data.x; this.me.y = data.y; }
                    if(data.type === 'move') { this.enemy.x = data.x; this.enemy.y = data.y; this.enemy.active = true; }
                    if(data.type === 'chat') Chat.add(data.msg, 'enemy');
                });
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            update() {
                let moved = false;
                const speed = 5;
                if(Input.keys.up) { this.me.y -= speed; moved = true; }
                if(Input.keys.down) { this.me.y += speed; moved = true; }
                if(Input.keys.left) { this.me.x -= speed; moved = true; }
                if(Input.keys.right) { this.me.x += speed; moved = true; }

                if(moved && Date.now() - this.lastSent > 30) {
                    if(this.conn) this.conn.send({type:'move', x: this.me.x, y: this.me.y});
                    this.lastSent = Date.now();
                }
            },

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Desenha Inimigo
                if(this.enemy.active) {
                    this.ctx.fillStyle = this.enemy.color;
                    this.ctx.fillRect(this.enemy.x, this.enemy.y, 40, 40);
                }
                
                // Desenha Eu
                this.ctx.fillStyle = this.me.color;
                this.ctx.fillRect(this.me.x, this.me.y, 40, 40);
            },

            loop() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        };

        const Input = {
            keys: { up: false, down: false, left: false, right: false },
            set(dir, state) { this.keys[dir] = state; }
        };

        const Chat = {
            send() {
                const el = document.getElementById('chat-input');
                const msg = el.value.trim();
                if(!msg) return;
                this.add(msg, 'me');
                if(Game.conn) Game.conn.send({type:'chat', msg: msg});
                el.value = '';
            },
            add(msg, sender) {
                const h = document.getElementById('chat-history');
                h.innerHTML += `<div><b style="color:${sender==='me'?'#4ecca3':'#ff6b6b'}">${sender}:</b> ${msg}</div>`;
                h.scrollTop = h.scrollHeight;
            }
        };

        window.addEventListener('resize', () => Game.resize());
    </script>
</body>
</html>
